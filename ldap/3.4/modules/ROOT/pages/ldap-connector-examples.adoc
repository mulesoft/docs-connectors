= LDAP Connector Connector 3.4 Examples - Mule 4

The following examples show how to do the following:

* Add a group and user to an organizatonal unit and then delete that user
* Set up a common trustore

[[add-delete-entry]]
== Adding and Deleting Groups and Users from an Organizational Unit

This example shows how to use the LDAP *Add entry* operation to add a group and user to an organizational unit and the *Delete entry* operation to delete a user from that organizational unit.

The following screenshot shows the Studio app flow for this example:

image::ldap-usecase-flow.png[Flow for adding and deleting users]

=== Add a User to an Organizational Unit

To add a user to an organizational unit:

. Create a new Mule Project in Anypoint Studio.
. Add these properties to the `mule-artifact.properties` file to hold your LDAP credentials, and place the file in the project's `src/main/resources` directory.
+
[source,text,linenums]
----
config.principal.dn=<DN>
config.password=<Password>
config.url=<URL>
----
+
. In Studio, click *HTTP* and drag the *Listener* source to the canvas.
. On the Listener properties window, change the display name of the *Listener* source to `HTTP`.
. Click *+* next to the *Connector configuration* field to add a global element.
. Accept the defaults.
. On the Listener properties window, set the *Path* field value to `/`.
. From the *Mule Palette* view, select *Core* and drag *Transform Message* to the right of *HTTP*.
. In the *Output* section, replace the existing text with th following DataWeave script:
+
[source,java,linenums]
----
%dw 2.0
output application/java
---
{
	dn : "ou=DevOpsGroup," ++ attributes.queryParams.dn,
	ou : "DevOpsGroup",
	objectclass : ["top", "organizationalUnit"]
}
----
+
. Drag the *Add entry* operation next to the *Transform Message* component to start adding an LDAP group.
. Click the plus sign next to the connector configuration field to add a new global element.
. Configure the global element according to the table below:
+
[%header%autowidth]
|===
|Parameter|Description|Value
|Name|Name of the configuration.|`LDAP_Configuration`
|Principal DN|User distinguished name (DN).|`${config.principal.dn}`
|Password|User password.|`${config.password}`
|URL|URL that connects to the LDAP server.|`${config.url}`
|===
+
. Click *Test Connection* to confirm that Mule can connect to the LDAP server instance.
. If the connection is successful, click *OK* to save the configuration.
+
Otherwise, review or correct any incorrect field values and test again.
. Return to the LDAP Connector properties window and configure the parameters required for the *Add entry* operation:
+
[%header%autowidth]
|===
|Parameter|Value
|Display Name|`Add Group Entry to LDAP Directory`
2+|Basic Settings
|Connector configuration|Select the global LDAP Connector element that you created.
2+|General
|Entry|Leave the default value.
|===
+
. Click the *Transform Message* component.
. In the *Output* section, add the following DataWeave script:
+
[source,java,linenums]
----
%dw 2.0
output application/java
---
{
	dn : "cn=Test User,ou=DevOpsGroup," ++ attributes.queryParams.dn,
	uid : "testUser",
	cn : "Test User",
	sn : "User",
	userPassword : "test1234",
	objectclass : ["top", "person", "organizationalPerson", "inetOrgPerson"]
}
----
+
. Drag the *Add entry* operation next to the *Transform Message* component to start adding an LDAP user.
. In LDAP Connector properties editor, configure the parameters as follows:
+
[%header%autowidth]
|===
|Parameter|Value
|Display Name|Enter `Add User Entry to LDAP Directory`.
2+|Basic Settings
|Connector configuration|Select the global LDAP Connector element that you created previously.
2+|General
|Entry| Leave the default value.
|===

=== Delete a User from an Organizational unit

Now that you have successfully added users to an organizational unit, try to delete them using LDAP Connector:

. Drag the *Delete entry* operation next to the *Add User Entry to LDAP Directory* on the canvas.
. In the LDAP Connector properties editor, configure the parameters as follows:
+
[%header%autowidth]
|===
|Parameter|Value
|Display Name|`Delete User Entry from LDAP Directory`
2+|Basic Settings
|Connector configuration|Select the global LDAP Connector element that you created previously.
2+|General
|DN|`#['cn=Test User,ou=DevOpsGroup,' ++ attributes.queryParams.dn]`
|===
+
. Drag another *Delete entry* operation next to the first one to start deleting the LDAP group entry.
+
[%header%autowidth]
|===
|Parameter|Value
|Display Name|`Delete Group Entry from LDAP Directory`
2+|Basic Settings
|Connector configuration|Select the global LDAP Connector element that you created previously.
2+|General
|DN|`#['ou=DevOpsGroup,' ++ attributes.queryParams.dn]`
|===
+
. Drag the *Transform Message* component next to *Delete Group Entry from LDAP Directory*.
. Set the payload to "Flow Successfully Completed".

=== Test the App

. Save and run the project as a Mule app.
. Test the app by opening a web browser and checking the response after entering this URL:
+
`http://localhost:8081/?dn=dc=mulesoft,dc=orgrequest to <url>`

=== XML for the Add and Delete User Example

Paste this code into your XML Editor to quickly load the flow for this example use case into your Mule application:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:ldap="http://www.mulesoft.org/schema/mule/ldap"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-current.xsd
	http://www.mulesoft.org/schema/mule/core
	http://www.mulesoft.org/schema/mule/core/current/mule.xsd
	http://www.mulesoft.org/schema/mule/http
	http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
	http://www.mulesoft.org/schema/mule/ldap
	http://www.mulesoft.org/schema/mule/ldap/current/mule-ldap.xsd
	http://www.mulesoft.org/schema/mule/ee/core
	http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">


	<http:listener-config name="HTTP_Listener_config"
		doc:name="HTTP Listener config">
		<http:listener-connection host="127.0.0.1"
			port="8081" />
	</http:listener-config>

	<ldap:config name="LDAP_Configuration" doc:name="LDAP Configuration">
		<ldap:basic-connection authDn="${config.principal.dn}"
			authPassword="${config.password}" url="${config.url}">
      <ldap:extended-configurations>
         <ldap:extended-configuration key="key.name" value="key.value" />
         </ldap:extended-configuration>
      </ldap:extended-configurations>
		</ldap:basic-connection>
	</ldap:config>

	<flow name="ldap-add-entry-flow">
		<http:listener config-ref="HTTP_Listener_config" path="/"
			doc:name="HTTP" />

		<ee:transform doc:name="DataWeave to Create DevOps Group Object">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
	dn : "ou=DevOpsGroup," ++ attributes.queryParams.dn,
	ou : "DevOpsGroup",
	objectclass : ["top", "organizationalUnit"]
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>

		<ldap:add config-ref="LDAP_Configuration"
			doc:name="Add Group Entry to LDAP Directory" />


		<ee:transform doc:name="DataWeave to Create User Object">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
	dn : "cn=Test User,ou=DevOpsGroup," ++ attributes.queryParams.dn,
	uid : "testUser",
	cn : "Test User",
	sn : "User",
	userPassword : "test1234",
	objectclass : ["top", "person", "organizationalPerson", "inetOrgPerson"]
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>


		<ldap:add config-ref="LDAP_Configuration"
			doc:name="Add User Entry to LDAP Directory" />

		<ldap:delete config-ref="LDAP_Configuration"
			dn="#['cn=Test User,ou=DevOpsGroup,' ++ attributes.queryParams.dn]"
			doc:name="Delete User Entry from LDAP Directory" />

		<ldap:delete config-ref="LDAP_Configuration"
			dn="#['ou=DevOpsGroup,' ++ attributes.queryParams.dn]"
			doc:name="Delete Group Entry from LDAP Directory" />

		<ee:transform doc:name="DataWeave to set Payload indicating flow completed">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	result : "Flow Successfully Completed"
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>

</mule>
----

[[set-up-common-truststore]]
== Setting Up a Common Trustore

This example shows how to use extended configuration parameters to set up a custom truststore to tell which servers are allowed to communicate to.

The following screenshot shows the Studio app flow for this example:



To set up a custom trustore:

. Follow the steps in the previous example.
. Locate the XML code for the following element:
+
[source,xml,linenums]
----
 <ldap:conf name=:DAP_configuration" doc:name="LDAP Configuration"
 .
 .
 .
 </ldap:config
 ----
+
. Paste this code in its place:
+
[source,xml,linenums]
----
<ldap:config name="LDAP_Configuration" doc:name="LDAP Configuration">
<ldap:tls-connection authDn="${config.principal.dn}"
        authPassword="${config.password}" url="${config.url}">
    <ldap:extended-configurations>
        <ldap:extended-configuration
        	key="org.mule.module.ldap.trustStorePath"
        	value="the_path_to_trust_store_jks_file" />
        <ldap:extended-configuration
        	key="org.mule.module.ldap.trustStorePassword"
        	value="changeit" />
    </ldap:extended-configurations>
</ldap:tls-connection>
</ldap:config>
----

[[run-time]]
=== Run Demo Application

. Save and run the project as a Mule Application.
. Open a web browser and check the response after entering the URL:
+
`+http://localhost:8081/?dn=dc=mulesoft,dc=org+`.






[%header%autowidth]
|===
|Field|Description
|Display Name|Enter a unique label for the LDAP operation in your application.
2+|Basic Settings
|Connector configuration|Connect to a global element linked to this connector. Global elements encapsulate reusable data about the connection to the target resource or service. Select the global LDAP Connector element that you created.
2+|General
|Entry|#[payload], which refers to an LDAPEntry object created in the previous component. This is typically a DataWeave component and is transformed as input payload to this processor.
|===
+
. Click the Refresh button just after the Structural object class text field to fetch the metadata based on the Structural Object Class, which traverses the directory information tree to retrieve the hierarchy and all the properties it inherits.
