= LDAP Connector Connector 3.4 Examples - Mule 4

The following examples show how to use LDAP Connector to:

* Add a group and user to an organizational unit and then delete that user and group
* Set up a common truststore

[[add-delete-entry]]
== Adding and Deleting Groups and Users from an Organizational Unit

This example shows how to use the LDAP *Add entry* operation to add a group and user to an organizational unit and the *Delete entry* operation to delete a user and group from that organizational unit.

The following screenshot shows the Studio app flow for this example:

image::ldap-usecase-flow.png[Flow for adding and deleting users]

=== Add a User to an Organizational Unit

To add a user to an organizational unit:

. Create a new Mule Project in Anypoint Studio.
. Add these properties to the `mule-artifact.properties` file to hold your LDAP credentials, and place the file in the project's `src/main/resources` directory.
+
[source,text,linenums]
----
config.principal.dn=<DN>
config.password=<Password>
config.url=<URL>
----
+
. In Studio, click *HTTP* and drag the *Listener* source to the canvas.
. On the Listener properties window, change the display name of the *Listener* source to `HTTP`.
. Click *+* next to the *Connector configuration* field to add a global element.
. Accept the defaults.
. On the Listener properties window, set the *Path* field value to `/`.
. From the *Mule Palette* view, select *Core* and drag the *Transform Message* component next to *HTTP*.
. In the *Output* section, replace the existing text with the following DataWeave script:
+
[source,java,linenums]
----
%dw 2.0
output application/java
---
{
	dn : "ou=DevOpsGroup," ++ attributes.queryParams.dn,
	ou : "DevOpsGroup",
	objectclass : ["top", "organizationalUnit"]
}
----
+
. From the *Mule Palette* view, select *LDAP* and drag the *Add entry* operation next to the *Transform Message* component to start adding an LDAP group.
. Click *+* next to the connector configuration field to add a new global element.
. Configure the global element according to the table below:
+
[%header%autowidth]
|===
|Parameter|Description|Value
|Name|Name of the configuration.|`LDAP_Configuration`
|Principal DN|User distinguished name (DN).|`${config.principal.dn}`
|Password|User password.|`${config.password}`
|URL|URL that connects to the LDAP server.|`${config.url}`
|===
+
. Click *Test Connection* to confirm that Mule can connect to the LDAP server instance.
. If the connection is successful, click *OK* to save the configuration.
+
Otherwise, review or correct any incorrect field values and test again.
. Return to the LDAP Connector properties window and configure the parameters required for the *Add entry* operation:
+
[%header%autowidth]
|===
|Parameter|Value
|Display Name|`Add Group Entry to LDAP Directory`
2+|Basic Settings
|Connector configuration|LDAP Connector global element that you created previously
2+|General
|Entry|`payload` (the default value)
|===
+
. From the *Mule Palette* view, select *Core* and drag the *Transform Message* component next to *Add Group Entry to the LDAP directory*.
. In the *Output* section, replace the existing text with the following DataWeave script:
+
[source,java,linenums]
----
%dw 2.0
output application/java
---
{
	dn : "cn=Test User,ou=DevOpsGroup," ++ attributes.queryParams.dn,
	uid : "testUser",
	cn : "Test User",
	sn : "User",
	userPassword : "test1234",
	objectclass : ["top", "person", "organizationalPerson", "inetOrgPerson"]
}
----
+
. From the *Mule Palette* view, select *LDAP* and drag the the *Add entry* operation next to *Transform Message* to start adding an LDAP user.
. In LDAP Connector properties editor, configure the parameters as follows:
+
[%header%autowidth]
|===
|Parameter|Value
|Display Name|Enter `Add User Entry to LDAP Directory`.
2+|Basic Settings
|Connector configuration|Select the LDAP Connector global element that you created previously
2+|General
|Entry| `payload` (the default value).
|===

=== Delete a User and Group from an Organizational Unit

Now that you have successfully added a user and group to an organizational unit, try to delete them using LDAP Connector:

. From the *Mule Palette* view, select *LDAP* and drag the *Delete entry* operation next to the *Add User Entry to LDAP Directory* on the canvas.
. In the LDAP Connector properties editor, configure the parameters as follows:
+
[%header%autowidth]
|===
|Parameter|Value
|Display Name|`Delete User Entry from LDAP Directory`
2+|Basic Settings
|Connector configuration|LDAP Connector global element that you created previously
2+|General
|DN|`#['cn=Test User,ou=DevOpsGroup,' ++ attributes.queryParams.dn]`
|===
+
. Drag another *Delete entry* operation next to the first one to start deleting the LDAP group entry.
+
[%header%autowidth]
|===
|Parameter|Value
|Display Name|`Delete Group Entry from LDAP Directory`
2+|Basic Settings
|Connector configuration|LDAP Connector global element that you created previously
2+|General
|DN|`#['ou=DevOpsGroup,' ++ attributes.queryParams.dn]`
|===
+
. Drag the *Transform Message* component next to *Delete Group Entry from LDAP Directory*.
. Set the payload to "Flow Successfully Completed".

=== Run the App

. Save the project and run it as a Mule app.
. Test the app by sending a `GET` request to this URL:
+
`http://localhost:8081/?dn=dc=mulesoft,dc=orgrequest to <url>`

=== XML for the Adding and Deleting Groups and Users from an Organizational Unit Example

Paste this code into your XML Editor to quickly load the flow for this example use case into your Mule app:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ldap="http://www.mulesoft.org/schema/mule/ldap" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/ldap
http://www.mulesoft.org/schema/mule/ldap/current/mule-ldap.xsd">
<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="74b34b41-4e8b-4b96-adec-da917b183083" >
<http:listener-connection host="0.0.0.0" port="8081" />
</http:listener-config>
<ldap:config name="LDAP_Configuration" doc:name="LDAP Configuration" doc:id="2e1caebb-d041-47ec-9513-69c140c78700" >
		<ldap:basic-connection authDn="${config.principal.dn}" authPassword="${config.password}" url="${config.url}" />
	</ldap:config>
	<flow name="ldap-examplesFlow" doc:id="dc01fbb8-1e2c-4255-be17-46309cdbef07" >
		<http:listener doc:name="HTTP" doc:id="180e5809-d508-498c-a74f-97d93afc98f8" config-ref="HTTP_Listener_config" path="/"/>
		<ee:transform doc:name="Transform Message" doc:id="183ca95a-dcc2-448f-8bba-26f7295fb1e4" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	dn : "ou=DevOpsGroup," ++ attributes.queryParams.dn,
	ou : "DevOpsGroup",
	objectclass : ["top", "organizationalUnit"]
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ldap:add doc:name="Add Group Entry to LDAP Directory" doc:id="95d60199-e087-4fe1-afa7-1c035fdd3aec" config-ref="LDAP_Configuration"/>
		<ee:transform doc:name="Transform Message" doc:id="0e96e606-48be-4ba0-9266-242bd9911184">
			<ee:message>
				<ee:set-payload><![CDATA[{
	dn : "cn=Test User,ou=DevOpsGroup," ++ attributes.queryParams.dn,
	uid : "testUser",
	cn : "Test User",
	sn : "User",
	userPassword : "test1234",
	objectclass : ["top", "person", "organizationalPerson", "inetOrgPerson"]
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ldap:add doc:name="Add User Entry to LDAP Directory" doc:id="28c98048-0ba6-4a36-92df-49d437303217" config-ref="LDAP_Configuration"/>
		<ldap:delete doc:name="Delete User Entry from LDAP Directory" doc:id="07e7141a-03d9-4565-bbca-8a4b03cbb6ee" config-ref="LDAP_Configuration" dn="#['cn=Test User,ou=DevOpsGroup,' ++ attributes.queryParams.dn]"/>
		<ldap:delete doc:name="Delete Group ENtry from LDAP Directory" doc:id="892dca59-86a3-40a2-b758-09560fb95383" config-ref="LDAP_Configuration" dn="#['ou=DevOpsGroup,' ++ attributes.queryParams.dn]"/>
		<ee:transform doc:name="Transform Message" doc:id="5dc391aa-87b1-4e84-97e5-71dc5f8daa22" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>
</mule>
----

[[set-up-common-truststore]]
== Setting Up a Common Truststore

This example shows how to use extended configuration parameters to set up a custom truststore to tell which servers are allowed to communicate to.

To set up a custom truststore:

. Follow the steps in the previous example.
. Add these properties to the `mule-artifact.properties` file to hold your LDAP credentials, and place the file in the project's `src/main/resources` directory.
+
[source,text,linenums]
----
config.principal.dn=<DN>
config.password=<Password>
config.url=<URL>
----
+
. Add this line to the `mule-artifact.properties` file in the project's `src/main/resources` directory:
+
`config.principal.dn=<PrincipalDn>`
+
. Locate the following element in the XML code:
+
[source,xml,linenums]
----
 <ldap:conf name=:LDAP_configuration" doc:name="LDAP Configuration"
 .
 .
 .
 </ldap:config
----
+
. Overlay the located element with the following code:
+
[source,xml,linenums]
----
<ldap:config name="LDAP_Configuration" doc:name="LDAP Configuration">
<ldap:tls-connection authDn="${config.principal.dn}"
        authPassword="${config.password}" url="${config.url}">
    <ldap:extended-configurations>
        <ldap:extended-configuration
        	key="org.mule.module.ldap.trustStorePath"
        	value="the_path_to_trust_store_jks_file" />
        <ldap:extended-configuration
        	key="org.mule.module.ldap.trustStorePassword"
        	value="changeit" />
    </ldap:extended-configurations>
</ldap:tls-connection>
</ldap:config>
----

[[run-time]]
=== Run Demo Application

. Save and run the project as a Mule Application.
. Open a web browser and check the response after entering this URL:
+
`+http://localhost:8081/?dn=dc=mulesoft,dc=org+`

= See Also

https://help.mulesoft.com[MuleSoft Help Center]
